# E2E Test Environment for SemStreams Core Components
#
# ⚠️  THIS FILE IS FOR E2E TESTING ONLY - DO NOT USE DIRECTLY ⚠️
#
# This compose file is designed to work with task commands:
#   - task e2e           - Run all E2E tests
#   - task e2e:health    - Run health check scenario
#   - task e2e:dataflow  - Run dataflow test scenario
#   - task e2e:clean     - Clean up test environment
#
# Running this directly will start services but NOT run tests.
# The E2E tests are executed from the host via cmd/e2e/e2e binary.
#
# Following Observer Pattern: E2E tests are external observers of the running system
services:
  # NATS Server with JetStream
  nats:
    image: nats:2.10-alpine
    container_name: semstreams-e2e-nats
    ports:
      - "4222:4222" # Client connections
      - "8222:8222" # HTTP monitoring
    command:
      ["-js", "-sd", "/data", "-m", "8222", "--name", "semstreams-e2e-nats"]
    volumes:
      - nats-semstreams-e2e-data:/data
    networks:
      - semstreams-e2e-net
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--quiet",
          "--tries=1",
          "--spider",
          "http://localhost:8222/healthz",
        ]
      interval: 5s
      timeout: 3s
      retries: 10

  # SemStreams Application (core components only)
  semstreams:
    build:
      context: ..
      dockerfile: semstreams/Dockerfile
      target: production
    container_name: semstreams-e2e-app
    depends_on:
      nats:
        condition: service_healthy
    environment:
      - SEMSTREAMS_CONFIG=/app/configs/protocol-flow.json
      - SEMSTREAMS_LOG_LEVEL=debug
    volumes:
      - ./configs:/app/configs:ro
    ports:
      - "8080:8080" # HTTP API (health, components)
      - "9090:9090" # Prometheus metrics
      - "14550:14550/udp" # UDP input
      - "8082:8082" # WebSocket output
    networks:
      - semstreams-e2e-net
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--quiet",
          "--tries=1",
          "--spider",
          "http://localhost:8080/health",
        ]
      interval: 5s
      timeout: 3s
      retries: 10

networks:
  semstreams-e2e-net:
    driver: bridge

volumes:
  nats-semstreams-e2e-data:
    driver: local
