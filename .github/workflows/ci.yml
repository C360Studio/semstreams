name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  GO_VERSION: "1.25"

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Install revive
        run: go install github.com/mgechev/revive@latest

      - name: Run go vet
        run: go vet ./...

      - name: Run go fmt
        run: |
          fmt_output=$(go fmt ./...)
          if [ -n "$fmt_output" ]; then
            echo "The following files need formatting:"
            echo "$fmt_output"
            exit 1
          fi

      - name: Run revive
        run: revive -config revive.toml -formatter friendly ./...

  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Pull NATS image
        run: docker pull nats:latest

      - name: Run unit tests
        run: go test -v -race ./...

      - name: Run integration tests
        run: go test -tags=integration -v -race ./...

  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Build binary
        run: |
          CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build \
            -ldflags="-w -s -X main.version=${{ github.sha }}" \
            -o semstreams-linux-amd64 \
            ./cmd/semstreams

      - name: Test binary execution
        run: |
          ./semstreams-linux-amd64 --version || true
          echo "Build successful"

  schema-validation:
    name: Schema Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Install task
        run: |
          sh -c "$(curl --location https://taskfile.dev/install.sh)" -- -d -b /usr/local/bin

      - name: Generate schemas and OpenAPI spec
        run: task schema:generate

      - name: Run schema exporter tests
        run: go test -v ./cmd/schema-exporter

      - name: Check for uncommitted schema changes
        run: |
          if ! git diff --exit-code schemas/ specs/openapi.v3.yaml; then
            echo "❌ Schema or OpenAPI files have uncommitted changes!"
            echo ""
            echo "The following files changed after running 'task schema:generate':"
            git diff --name-only schemas/ specs/openapi.v3.yaml
            echo ""
            echo "Please run 'task schema:generate' locally and commit the changes."
            exit 1
          fi
          echo "✅ All schemas and OpenAPI spec are up to date"

  status-check:
    name: CI Status Check
    runs-on: ubuntu-latest
    needs: [lint, test, build, schema-validation]
    if: always()
    steps:
      - name: Check if all jobs succeeded
        run: |
          if [[ "${{ needs.lint.result }}" != "success" ]] || \
             [[ "${{ needs.test.result }}" != "success" ]] || \
             [[ "${{ needs.build.result }}" != "success" ]] || \
             [[ "${{ needs.schema-validation.result }}" != "success" ]]; then
            echo "One or more CI jobs failed"
            exit 1
          fi
          echo "All CI jobs passed successfully"
